<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Service Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1c2128;
            --bg-hover: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --accent: #58a6ff;
            --success: #238636;
            --error-base: #da3633;
            
            /* –ì—Ä–∞–¥–∞—Ü–∏—è –¥–ª—è –æ—à–∏–±–æ–∫ */
            --color-empty: #161b22;
            --color-neutral: #2d333b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-button:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .nav-button:active {
            transform: scale(0.95);
        }

        .current-month {
            font-size: 20px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .legend {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Calendar Grid */
        .calendar-container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .weekday {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 10px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 80px;
            padding: 8px;
        }

        .day-cell:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
        }

        .day-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .day-cell.no-data {
            background: var(--color-neutral);
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .error-count {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 1200px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-content {
            padding: 24px;
        }

        .error-summary {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border-left: 3px solid var(--error-base);
        }

        .error-total {
            font-size: 32px;
            font-weight: 700;
            color: var(--error-base);
            margin-bottom: 8px;
        }

        .error-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .modules-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .module-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .module-name {
            font-size: 16px;
            font-weight: 600;
        }

        .module-errors {
            background: var(--error-base);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .module-errors.zero {
            background: var(--success);
        }

        .module-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 14px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Detailed Tables */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 13px;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
        }

        .details-table th {
            background: var(--bg-hover);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .details-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .details-table tr:last-child td {
            border-bottom: none;
        }

        .details-table tr:hover {
            background: var(--bg-hover);
        }

        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .no-data-message {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 13px;
            font-style: italic;
        }

        .expand-button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .expand-button:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 3000px;
        }

        .highlight-value {
            color: var(--error-base);
            font-weight: 600;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Billing Service Dashboard</h1>
            <p class="subtitle">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å –ê–ó–°</p>
        </header>

        <div class="navigation">
            <div class="month-selector">
                <button class="nav-button" id="prevMonth">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="current-month" id="currentMonth">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button class="nav-button" id="nextMonth">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-box" style="background: var(--color-neutral);"></div>
                    <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: var(--success);"></div>
                    <span>–ë–µ–∑ –æ—à–∏–±–æ–∫</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: linear-gradient(to right, #ffa500, #ff4500, #dc143c);"></div>
                    <span>–ï—Å—Ç—å –æ—à–∏–±–∫–∏ (–≥—Ä–∞–¥–∞—Ü–∏—è)</span>
                </div>
            </div>
        </div>

        <div class="calendar-container">
            <div class="weekdays">
                <div class="weekday">–ü–ù</div>
                <div class="weekday">–í–¢</div>
                <div class="weekday">–°–†</div>
                <div class="weekday">–ß–¢</div>
                <div class="weekday">–ü–¢</div>
                <div class="weekday">–°–ë</div>
                <div class="weekday">–í–°</div>
            </div>
            <div class="calendar" id="calendar">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>

        <div class="stats" id="stats"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">–î–µ—Ç–∞–ª–∏</div>
                <button class="close-button" id="closeModal">&times;</button>
            </div>
            <div class="modal-content" id="modalContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let dashboardData = {};
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0-11
        let maxErrors = 0;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const response = await fetch('dashboard_data.json');
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                dashboardData = await response.json();
                calculateMaxErrors();
                renderCalendar();
                renderStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('calendar').innerHTML = 
                    '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ó–∞–ø—É—Å—Ç–∏—Ç–µ aggregate_dashboard_data.py</div>';
            }
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –≥—Ä–∞–¥–∞—Ü–∏–∏
        function calculateMaxErrors() {
            maxErrors = 0;
            Object.values(dashboardData).forEach(monthData => {
                Object.values(monthData).forEach(dayData => {
                    if (dayData.errors > maxErrors) {
                        maxErrors = dayData.errors;
                    }
                });
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —è—á–µ–π–∫–∏ –¥–Ω—è
        function getColorForErrors(errors) {
            if (errors === 0) {
                return 'hsl(142, 50%, 30%)'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è 0 –æ—à–∏–±–æ–∫
            }
            
            // –ü–ª–∞–≤–Ω–∞—è –≥—Ä–∞–¥–∞—Ü–∏—è –æ—Ç –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ –¥–æ —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º HSL: Hue (–æ—Ç—Ç–µ–Ω–æ–∫), Saturation (–Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å), Lightness (—è—Ä–∫–æ—Å—Ç—å)
            // –û—Ç—Ç–µ–Ω–æ–∫: 30 (–æ—Ä–∞–Ω–∂–µ–≤—ã–π) ‚Üí 0 (–∫—Ä–∞—Å–Ω—ã–π)
            // –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å: 80-100%
            // –Ø—Ä–∫–æ—Å—Ç—å: 50-60%
            
            const ratio = Math.min(errors / maxErrors, 1); // 0 to 1
            
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç—Ç–µ–Ω–∫–∞
            const hue = 30 - (ratio * 30); // 30 (–æ—Ä–∞–Ω–∂–µ–≤—ã–π) -> 0 (–∫—Ä–∞—Å–Ω—ã–π)
            const saturation = 80 + (ratio * 20); // 80% -> 100%
            const lightness = 55 - (ratio * 10); // 55% -> 45% (—Ç–µ–º–Ω–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ)
            
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
        function formatMonth(year, month) {
            const date = new Date(year, month, 1);
            return date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –º–µ—Å—è—Ü–∞
        function getMonthKey(year, month) {
            return `${year}-${String(month + 1).padStart(2, '0')}`;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function renderCalendar() {
            const monthKey = getMonthKey(currentYear, currentMonth);
            const monthData = dashboardData[monthKey] || {};
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('currentMonth').textContent = formatMonth(currentYear, currentMonth);
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 = –í—Å, –Ω—É–∂–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ 0 = –ü–Ω)
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                calendar.appendChild(emptyCell);
            }
            
            // –Ø—á–µ–π–∫–∏ —Å –¥–Ω—è–º–∏
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${monthKey}-${String(day).padStart(2, '0')}`;
                const dayData = monthData[dateStr];
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (dayData) {
                    const errors = dayData.errors;
                    const color = getColorForErrors(errors);
                    dayCell.style.background = color;
                    
                    dayCell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="error-count">${errors === 0 ? '‚úì' : errors}</div>
                    `;
                    
                    dayCell.addEventListener('click', () => showDetails(dateStr, dayData));
                } else {
                    dayCell.classList.add('no-data');
                    dayCell.innerHTML = `<div class="day-number">${day}</div>`;
                }
                
                calendar.appendChild(dayCell);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –¥–Ω—è
        function showDetails(dateStr, dayData) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            const date = new Date(dateStr);
            title.textContent = date.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'short'
            });
            
            const modules = dayData.modules;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å–º–µ–Ω
            function createShiftsTable(details) {
                if (!details.missing_shifts || details.missing_shifts.length === 0) {
                    return '<div class="no-data-message">‚úì –ù–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω</div>';
                }
                
                let html = '<table class="details-table">';
                html += '<thead><tr><th>#</th><th>–ê–ó–°</th><th>–ù–æ–º–µ—Ä–∞ —Å–º–µ–Ω</th><th>–í –≠–•–û</th><th>–í BI</th><th>–ü—Ä–æ–ø—É—â–µ–Ω–æ</th></tr></thead>';
                html += '<tbody>';
                
                details.missing_shifts.forEach((shift, idx) => {
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä–∞ —Å–º–µ–Ω
                    const shiftNumbers = shift.eho_shift_numbers || [];
                    const shiftNumsText = shiftNumbers.length > 0 
                        ? shiftNumbers.join(', ') 
                        : '-';
                    
                    html += `<tr>
                        <td style="color: var(--text-secondary);">${idx + 1}</td>
                        <td><strong>${shift.sitExtCode}</strong></td>
                        <td class="highlight-value">${shiftNumsText}</td>
                        <td>${shift.eho_shifts || 0}</td>
                        <td>${shift.bi_shifts || 0}</td>
                        <td class="highlight-value">${shift.missing || 0}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                return html;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ä—Ç
            function createCardsTable(details) {
                if ((!details.receipts || details.receipts.length === 0) && 
                    (!details.emergency_payments || details.emergency_payments.length === 0)) {
                    return '<div class="no-data-message">‚úì –ù–µ—Ç —á–µ–∫–æ–≤ –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>';
                }
                
                let html = '';
                
                // –ß–µ–∫–∏ –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
                if (details.receipts && details.receipts.length > 0) {
                    html += '<div class="detail-section-title">üí≥ –ß–µ–∫–∏ –±–µ–∑ ID —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:</div>';
                    html += '<table class="details-table">';
                    html += '<thead><tr><th>#</th><th>–ê–ó–°</th><th>–ß–µ–∫ ID</th><th>–î–∞—Ç–∞</th><th>–í–∏–¥ –æ–ø–ª–∞—Ç—ã</th><th>–°—É–º–º–∞</th></tr></thead>';
                    html += '<tbody>';
                    
                    details.receipts.forEach((receipt, idx) => {
                        html += `<tr>
                            <td style="color: var(--text-secondary);">${idx + 1}</td>
                            <td><strong>${receipt.–ù–æ–º–µ—Ä–ê–ó–° || receipt.sitCode}</strong></td>
                            <td>${receipt.–ß–µ–∫ID || ''}</td>
                            <td>${receipt.–î–∞—Ç–∞–ß–µ–∫–∞ || ''}</td>
                            <td>${receipt.–í–∏–¥–û–ø–ª–∞—Ç—ã || ''}</td>
                            <td class="highlight-value">${(receipt.–°—É–º–º–∞ || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                }
                
                // –ê–≤–∞—Ä–∏–π–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
                if (details.emergency_payments && details.emergency_payments.length > 0) {
                    html += '<div class="detail-section-title">üÜò –ê–≤–∞—Ä–∏–π–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏):</div>';
                    
                    const maxShow = 5;
                    const payments = details.emergency_payments;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
                    html += '<table class="details-table">';
                    html += '<thead><tr><th>#</th><th>–ê–ó–°</th><th>–ß–µ–∫ ID</th><th>–í–∏–¥ –æ–ø–ª–∞—Ç—ã</th><th>–°—É–º–º–∞</th></tr></thead>';
                    html += '<tbody>';
                    
                    payments.slice(0, maxShow).forEach((payment, idx) => {
                        html += `<tr>
                            <td style="color: var(--text-secondary);">${idx + 1}</td>
                            <td><strong>${payment.–ù–æ–º–µ—Ä–ê–ó–° || ''}</strong></td>
                            <td>${payment.–ß–µ–∫ID || ''}</td>
                            <td>${payment.–í–∏–¥–û–ø–ª–∞—Ç—ã || ''}</td>
                            <td>${(payment.–°—É–º–º–∞ || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    
                    // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 5 - –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–∫—Ä—ã—Ç—É—é —Ç–∞–±–ª–∏—Ü—É —Å–æ –í–°–ï–ú–ò –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏
                    if (payments.length > maxShow) {
                        const expandId = 'emergency_' + Date.now();
                        html += `<button class="expand-button" onclick="toggleCollapsible('${expandId}', this, ${payments.length})">
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${payments.length} –ø–ª–∞—Ç–µ–∂–µ–π ‚ñº
                        </button>`;
                        html += `<div class="collapsible-content" id="${expandId}">`;
                        html += '<table class="details-table" style="margin-top: 8px;">';
                        html += '<thead><tr><th>#</th><th>–ê–ó–°</th><th>–ß–µ–∫ ID</th><th>–í–∏–¥ –æ–ø–ª–∞—Ç—ã</th><th>–°—É–º–º–∞</th></tr></thead>';
                        html += '<tbody>';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ (—Å maxShow –¥–æ –∫–æ–Ω—Ü–∞)
                        payments.slice(maxShow).forEach((payment, idx) => {
                            html += `<tr>
                                <td style="color: var(--text-secondary);">${maxShow + idx + 1}</td>
                                <td><strong>${payment.–ù–æ–º–µ—Ä–ê–ó–° || ''}</strong></td>
                                <td>${payment.–ß–µ–∫ID || ''}</td>
                                <td>${payment.–í–∏–¥–û–ø–ª–∞—Ç—ã || ''}</td>
                                <td>${(payment.–°—É–º–º–∞ || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                    }
                }
                
                return html || '<div class="no-data-message">‚úì –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã webkassa
            function createWebkassaTable(details) {
                if (!details.discrepancies || details.discrepancies.length === 0) {
                    return '<div class="no-data-message">‚úì –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π</div>';
                }
                
                let html = '<table class="details-table">';
                html += '<thead><tr><th>#</th><th>–ê–ó–°</th><th>–≠–•–û —Å—É–º–º–∞</th><th>Webkassa —Å—É–º–º–∞</th><th>–†–∞–∑–Ω–∏—Ü–∞</th><th>%</th></tr></thead>';
                html += '<tbody>';
                
                details.discrepancies.forEach((disc, idx) => {
                    // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ß–∏—Å—Ç–∞—è–°—É–º–º–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    const ehoSum = disc.eho?.–ß–∏—Å—Ç–∞—è–°—É–º–º–∞ || disc.eho?.–°—É–º–º–∞–ü—Ä–æ–¥–∞–∂ || 0;
                    const wkSum = disc.webkassa?.–ß–∏—Å—Ç–∞—è–°—É–º–º–∞ || disc.webkassa?.–°—É–º–º–∞–ü—Ä–æ–¥–∞–∂ || 0;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω–∏—Ü—É –∏–∑ –æ—Ç—á–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º
                    const diff = disc.difference || Math.abs(ehoSum - wkSum);
                    
                    // –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                    const percent = ehoSum > 0 ? ((diff / ehoSum) * 100) : 0;
                    
                    html += `<tr>
                        <td style="color: var(--text-secondary);">${idx + 1}</td>
                        <td><strong>${disc.key?.split('_')[0] || ''}</strong></td>
                        <td>${ehoSum.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                        <td>${wkSum.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                        <td class="highlight-value">${diff.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚Ç∏</td>
                        <td class="highlight-value">${percent.toFixed(2)}%</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                return html;
            }
            
            content.innerHTML = `
                <div class="error-summary">
                    <div class="error-total">${dayData.errors}</div>
                    <div class="error-label">–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫ –∑–∞ –¥–µ–Ω—å</div>
                </div>
                
                <div class="modules-section">
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-name">üîÑ –ú–æ–¥—É–ª—å 1: –°–º–µ–Ω—ã (–≠–•–û ‚Üî BI)</div>
                            <div class="module-errors ${modules.shifts.errors === 0 ? 'zero' : ''}">${modules.shifts.errors}</div>
                        </div>
                        <div class="module-details">
                            ${modules.shifts.bi_only ? `
                            <div class="detail-row">
                                <span>–¢–æ–ª—å–∫–æ –≤ BI (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏):</span>
                                <span class="detail-value">${modules.shifts.bi_only}</span>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <span>–û—Ç–∫—Ä—ã—Ç—ã–µ —Å–º–µ–Ω—ã:</span>
                                <span class="detail-value">${modules.shifts.open_shifts}</span>
                            </div>
                            <div class="detail-row">
                                <span>–ù–µ –ø–æ–ª—É—á–µ–Ω—ã:</span>
                                <span class="detail-value">${modules.shifts.missing_shifts}</span>
                            </div>
                        </div>
                        ${modules.shifts.details ? `
                        <div class="detail-section-title">üìã –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã:</div>
                        ${createShiftsTable(modules.shifts.details)}
                        ` : ''}
                    </div>
                    
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-name">üí≥ –ú–æ–¥—É–ª—å 2: –ö–∞—Ä—Ç—ã –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>
                            <div class="module-errors ${modules.cards.errors === 0 ? 'zero' : ''}">${modules.cards.errors}</div>
                        </div>
                        <div class="module-details">
                            <div class="detail-row">
                                <span>–ß–µ–∫–æ–≤ –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:</span>
                                <span class="detail-value">${modules.cards.total_receipts}</span>
                            </div>
                            <div class="detail-row">
                                <span>–ê–≤–∞—Ä–∏–π–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:</span>
                                <span class="detail-value">${modules.cards.emergency_count}</span>
                            </div>
                        </div>
                        ${modules.cards.details ? createCardsTable(modules.cards.details) : ''}
                    </div>
                    
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-name">üåê –ú–æ–¥—É–ª—å 2.1: Webkassa</div>
                            <div class="module-errors ${modules.webkassa.errors === 0 ? 'zero' : ''}">${modules.webkassa.errors}</div>
                        </div>
                        <div class="module-details">
                            <div class="detail-row">
                                <span>–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è:</span>
                                <span class="detail-value">${modules.webkassa.discrepancies}</span>
                            </div>
                            <div class="detail-row">
                                <span>–¢–æ–ª—å–∫–æ –≤ –≠–•–û:</span>
                                <span class="detail-value">${modules.webkassa.eho_only}</span>
                            </div>
                            <div class="detail-row">
                                <span>–¢–æ–ª—å–∫–æ –≤ Webkassa:</span>
                                <span class="detail-value">${modules.webkassa.webkassa_only}</span>
                            </div>
                        </div>
                        ${modules.webkassa.details ? `
                        <div class="detail-section-title">üìä –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ –ê–ó–°:</div>
                        ${createWebkassaTable(modules.webkassa.details)}
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–ª–∞–¥—ã–≤–∞–µ–º—ã—Ö –±–ª–æ–∫–æ–≤
        window.toggleCollapsible = function(contentId, button, totalCount) {
            const content = document.getElementById(contentId);
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                button.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${totalCount} –ø–ª–∞—Ç–µ–∂–µ–π ‚ñº`;
            } else {
                content.classList.add('expanded');
                button.textContent = '–°–∫—Ä—ã—Ç—å ‚ñ≤';
            }
        };

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function renderStats() {
            const monthKey = getMonthKey(currentYear, currentMonth);
            const monthData = dashboardData[monthKey] || {};
            
            let totalErrors = 0;
            let daysWithErrors = 0;
            let daysWithData = 0;
            
            Object.values(monthData).forEach(dayData => {
                daysWithData++;
                totalErrors += dayData.errors;
                if (dayData.errors > 0) daysWithErrors++;
            });
            
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${daysWithData}</div>
                    <div class="stat-label">–î–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalErrors}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysWithErrors}</div>
                    <div class="stat-label">–î–Ω–µ–π —Å –æ—à–∏–±–∫–∞–º–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${daysWithData > 0 ? (totalErrors / daysWithData).toFixed(1) : 0}</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –æ—à–∏–±–æ–∫/–¥–µ–Ω—å</div>
                </div>
            `;
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            renderStats();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            renderStats();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('modalOverlay').classList.remove('active');
        });

        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
    </script>
</body>
</html>